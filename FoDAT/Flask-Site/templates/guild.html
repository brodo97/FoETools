{% extends "base.html" %}
{% block head %}
<style>
    .material-icons{
        display: inline-flex;
        vertical-align: top;
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
{% endblock %}
{% block content %}
<h2 class="center black-text">Dati ere di {{ guildName }}</h2>
<div class="row">
    <div class="col s12 m8 offset-m2">
        <div class="card white row">
            <div class="card-content">
                <span class="card-title">Cerca un'era</span>
                <div class="input-field col s10 offset-s1">
                    <i class="material-icons prefix">search</i>
                    <input type="text" id="autocomplete-input" class="autocomplete">
                    <label for="autocomplete-input">Nome</label>
                </div>
            </div>
        </div>
    </div>
    <div class="col s12">
        <div class="card">
            <div class="card-content">
                <div id="chart"></div>
            </div>
        </div>
    </div>
    <div class="col s12 m10 offset-m1">
        <div class="card white">
            <div class="card-content">
                <span class="card-title" id="titolo">Tabella dati</span>
                <table class="striped">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Quantit√† totale</th>
                            <th>Differenza</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<div class="fixed-action-btn">
    <a class="btn-floating btn-large black">
        <i class="large material-icons">menu</i>
    </a>
    <ul>
        <li><a class="btn-floating red" href="/getData" title="Torna alla pagina precedente"><i class="material-icons">arrow_left</i></a></li>
        <li><a class="btn-floating blue" id="act"></a></li>
    </ul>
</div>
<br>
<br>
<script src="{{url_for('static', filename='numeral.js')}}" type="text/javascript"></script>
<script src="{{url_for('static', filename='Functions.js')}}" type="text/javascript"></script>
<script type="text/javascript">
    let eras = {{ eras|safe }};
    let dates = {{ dates|safe }};
    let allDates = {{ allDates|safe }};
    let colors = ["#008FFB", "#00E396", "#FFAD0F", "#FF4560", "#775DD0"];
    let chartSettings = {height: 400, type: "line", stacked: false,
                         animations: {enabled: true, easing: 'easeinout', speed: 1000, animateGradually: {enabled: true, delay: 1000}, dynamicAnimation: {enabled: true, speed: 1000}}};

    let options = {
        chart: chartSettings,
        title: {text: "Storico beni era", align: "left"},
        dataLabels: {enabled: false},
        series: [],
        xaxis: {categories: dates}
    };

    let chart = new ApexCharts(document.querySelector("#chart"), options);

    chart.render();

    let total = [];
    for (let k in dates){
        total.push(0);
    }

    eras["Totale beni"] = {"Totale": total};

    for (let era in eras) {
        if (era !== "Tutte le Ere" && era !== "Totale beni") {
            for (let good in eras[era]) {
                for (let i in eras[era][good]) {
                    eras["Totale beni"]["Totale"][i] = eras["Totale beni"]["Totale"][i] + eras[era][good][i];
                }
            }
        }
    }


    $(document).ready(function(){
        initActionBtn(location, document.getElementById("act"));
        $('.fixed-action-btn').floatingActionButton({hoverEnabled: false, direction: "left"});
        $('input.autocomplete').autocomplete({
            data: {
                "Totale beni": null,
                {% for nome in eras %}"{{ nome|safe }}": null,
                {% endfor %}
            },
            onAutocomplete: function(name){
                let series = [];
                let yaxis = [];
                let c = 0;

                for (let i in eras[name]) {
                    let data = [];
                    let j = 0;

                    for (let k in allDates) {
                        if (dates.indexOf(allDates[k]) !== -1) {
                            data.push(eras[name][i][j]);
                            j++;
                        }else{
                            data.push(null);
                        }
                    }

                    series.push({name: i, data: data});
                    yaxis.push({
                        min: getMin(eras[name][i]),
                        max: getMax(eras[name][i]),
                        axisTicks: {show: true},
                        axisBorder: {show: true, color: colors[c]},
                        title: {text: i, style: {color: colors[c]}},
                        labels: {style: {color: colors[c]},
                            formatter: function (value) {
                                return numeral(value).format("0,0");
                            }
                        }
                    });
                    c++;
                }

                chart.updateOptions({
                    chart: chartSettings,
                    title: {text: "Storico " + name, align: "left"},
                    dataLabels: {enabled: false},
                    theme: {palette: "palette1"},
                    stroke: {curve: "smooth"},
                    series: series,
                    xaxis: {labels: {rotate: -90, rotateAlways: true}, categories: allDates},
                    yaxis: yaxis,
                    legend: {horizontalAlign: "left", position: "top"}
                });

                total = [];
                for (let k in dates){
                    total.push(0);
                }

                for (let good in eras[name]) {
                    for (let i in dates) {
                        total[i] = total[i] + eras[name][good][i];
                    }
                }

                $("#titolo").text(`Dati per '${name}' degli ultimi ${allDates.length} giorni`);
                $("tbody").empty();
                let x = 0;
                for (let i in allDates) {
                    $("tbody").append(`<tr id="tr${i}"><td>${allDates[i]}</td></tr>`);
                    if (dates.indexOf(allDates[i]) !== -1){
                        $(`#tr${i}`).append(`<td>${numeral(total[x]).format("0,0")}</td>`);
                        if (i > 0) {
                            let diff = parseInt(total[x]) - parseInt(total[x-1]);
                            if (diff > 0) {
                                $(`#tr${i}`).append(`<td><p class="green-text">+${numeral(diff).format("0,0")}<i class="material-icons">arrow_upward</i></p></td>`);
                            } else if (diff < 0) {
                                $(`#tr${i}`).append(`<td><p class="red-text">${numeral(diff).format("0,0")}<i class="material-icons">arrow_downward</i></p></td>`);
                            } else {
                                $(`#tr${i}`).append(`<td><p class="blue-text">${numeral(diff).format("0,0")}</p></td>`);
                            }
                        }else{
                            $(`#tr${i}`).append("<td>No Data</td>");
                        }
                        x++;
                    }else{
                        $(`#tr${i}`).append("<td>No Data</td><td>No Data</td>");
                    }
                }

                $("tbody").append(`<tr id="trlast"><td>Dal ${dates[0]} al ${dates[dates.length-1]}</td></tr>`);
                $("#trlast").append("<td></td>");
                let firstLast = (parseInt(total[dates.length-1]) - parseInt(total[0]));
                if (firstLast > 0) {
                    $("#trlast").append(`<td><p class="green-text">+${numeral(firstLast).format("0,0")}<i class='material-icons'>arrow_upward</i></p></td>`);
                } else if (firstLast < 0) {
                    $("#trlast").append(`<td><p class="red-text">${numeral(firstLast).format("0,0")}<i class='material-icons'>arrow_downward</i></p></td>`);
                } else {
                    $("#trlast").append(`<td><p class="blue-text">${numeral(firstLast).format("0,0")}</p></td>`);
                }
            }
        });
    });
</script>
{% endblock %}