{% extends "base.html" %}
{% block head %}
<style>
    .material-icons{
        display: inline-flex;
        vertical-align: top;
    }
</style>
{% endblock %}
{% block content %}
<h2 class="center black-text">Dati ere di {{ name }}</h2>
<div class="row">
	<div class="col s12 m8 offset-m2">
		<div class="card white row">
		    <div class="card-content">
    		    <span class="card-title">Cerca un'era</span>
    		    <div class="input-field col s10 offset-s1">
    		        <i class="material-icons prefix">search</i>
        			<input type="text" id="autocomplete-input" class="autocomplete">
        			<label for="autocomplete-input">Nome</label>
    		    </div>
		    </div>
		</div>
	</div>
	<div class="col s12 m10 offset-m1">
        <div class="card white">
            <div class="card-content chart-container" style="height:50vh">
                <canvas id="g4e"></canvas>
            </div>
            <div class="card-action">
                <p>
                    <label>
                        <input id="togglecheck" type="checkbox" checked="checked" onclick="changeCheck(this)"/>
                        <span>Abilita/disabilita aggiornamento dati automatico</span>
                    </label>
                </p>
            </div>
        </div>
    </div>
	<div class="col s12 m10 offset-m1">
		<div class="card white">
			<div class="card-content">
			    <span class="card-title" id="titolo">Dati</span>
				<table class="striped">
					<thead>
						<tr>
							<th>Data</th>
							<th>Quantit√† totale</th>
							<th>Differenza</th>
						</tr>
					</thead>
					<tbody>
						{% for data in allDates %}
						    {% if data in dates %}
						<tr>
							<td><p>{{ data }}</p></td>
							<td id="{{ data }}_quantity">No Data</td>
							<td id="{{ data }}_diff">No Data</td>
						</tr>
						    {% else %}
						<tr>
							<td><p>{{ data }}</p></td>
							<td>No Data</td>
							<td>No Data</td>
						</tr>
						    {% endif %}
						{% endfor %}
						<tr>
							<td><p>Da {{allDates[0]}} a {{allDates[-1]}}</p></td>
							<td></td>
							<td id="firstLast">No Data</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
	</div>
</div>
<div class="fixed-action-btn">
    <a class="btn-floating btn-large black">
        <i class="large material-icons">menu</i>
    </a>
    <ul>
        <li><a class="btn-floating red" href="/getData" title="Torna alla pagina precedente"><i class="material-icons">arrow_left</i></a></li>
        <li><a class="btn-floating blue" id="act"></a></li>
    </ul>
</div>
<br>
<br>
<script src="{{url_for('static', filename='Chart.js')}}" type="text/javascript"></script>
<script src="{{url_for('static', filename='numeral.js')}}" type="text/javascript"></script>
<script>
    var g4eOptions = {
        animation: {
            duration: 1000,
        },
        scales: {
            yAxes: [{
                ticks: {
                    beginAtZero: false
                }
            }],
            xAxes: [{
                ticks: {
                    autoSkip: true,
                    maxRotation: 90,
                    minRotation: 90
                }
            }]

        },
        title: {
                display: true,
                text: "Beni per era"
        },
        legend: {display: true},
        tooltips: {
                        mode: 'index',
                        intersect: false,
                    },
                    hover: {
                        mode: 'nearest',
                        intersect: true
                    },
        responsive: true,
        maintainAspectRatio: false,
    };
    var g4eCanvas = document.getElementById("g4e");
    var g4eCTX = g4eCanvas.getContext('2d');
    var g4eData = {labels: {{ dates|safe }}, datasets: []};

    Chart.plugins.register({
        beforeDraw: function(chartInstance) {
            var ctx = chartInstance.chart.ctx;
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, chartInstance.chart.width, chartInstance.chart.height);
        }
    });

    var g4eChart = new Chart(g4eCTX, {type: 'line', data: g4eData, options: g4eOptions});
</script>
<script type="text/javascript">
    let eras = {{ eras|safe }};
    let dates = {{ dates|safe }};
    let allDates = {{ allDates|safe }};
    let colors = ["#055c85", "#339faa", "#e8e699", "#f09b44", "#f52e2e"];

    let total = [];
    for (let k in dates){
        total.push(0);
    }

    eras["Totale beni"] = {"Totale": total};

    for (let era in eras) {
        if (era !== "Totale beni") {
            for (let good in eras[era]) {
                for (let i in eras[era][good]) {
                    eras["Totale beni"]["Totale"][i] = eras["Totale beni"]["Totale"][i] + eras[era][good][i];
                }
            }
        }
    }

	window.onload = function () {
		var x = location.search;
		var btn = document.getElementById("act");
		if (x === "?detailed") {
			btn.innerHTML = "<i class=\"material-icons\">remove</i>";
			btn.href = "/getData/eras";
			btn.title = "Riduci dettagli";
		}else{
			btn.innerHTML = "<i class=\"material-icons\">add</i>";
			btn.href = "/getData/eras?detailed";
			btn.title = "Aumenta dettagli";
		}
		changeCheck(document.getElementById("togglecheck"));
	}

	let toggle = 0;
	let loop = null;
    function changeCheck(obj) {
        if (obj.checked && loop == null) {
            loop = setInterval(function(){
                let n = g4eChart.data.datasets.length
                for (let z = 0; z < n; z++) {
                    g4eChart.data.datasets[z].hidden = true;
                };
                if (n > 0) {
                    g4eChart.data.datasets[toggle].hidden = false;
                    toggle ++;
                    g4eChart.update();
                    if (toggle >= n) {
                        toggle = 0;
                    }
                }
            }, 3000);
        }
        if (!obj.checked) {
            clearInterval(loop);
            loop = null;
        }
    }

	$(document).ready(function(){
	    $('.fixed-action-btn').floatingActionButton({hoverEnabled: false, direction: "left"});
        $('input.autocomplete').autocomplete({
            data: {
                "Totale beni": null,
                {% for nome in eras %}"{{ nome|safe }}": null,
                {% endfor %}
            },
            onAutocomplete: function(name){
                toggle = 0;
                let n = g4eChart.data.datasets.length

                for (let z = 0; z < n; z++) {
                    g4eChart.data.datasets.pop();
                };

                total = [];
                let l = 0;

                for (let k in dates){
                    total.push(0);
                }

                for (let good in eras[name]) {
                    let line = []
                    for (let i in dates) {
                        total[i] = total[i] + eras[name][good][i];
                        line.push(eras[name][good][i]);
                    }
                    g4eChart.data.datasets.push({label: good, data: line, backgroundColor: colors[l]+"60", borderColor: colors[l]+"FF", hidden: true});
                    l++;
                }

                if (name !== "Totale beni"){
                    g4eChart.data.datasets.push({label: "Totale", data: total, backgroundColor: "#00000060", borderColor: "#000000FF", hidden: true});
                }

                g4eChart.update();

                for (let i in dates) {
                    document.getElementById(dates[i] + "_quantity").innerHTML = numeral(total[i]).format("0,0");
                    if (i > 0) {
                        let diff = parseInt(total[i]) - parseInt(total[i-1]);
                        let text = "";
                        if (diff > 0) {
                            text += "<p class='green-text'>+" + numeral(diff).format("0,0") + "<i class='material-icons'>arrow_upward</i></p>";
                        } else if (diff < 0) {
                            text += "<p class='red-text'>" + numeral(diff).format("0,0") + "<i class='material-icons'>arrow_downward</i></p>";
                        } else {
                            text += "<p class='blue-text'>" + numeral(diff).format("0,0") + "</p>";
                        }
                        document.getElementById(dates[i] + "_diff").innerHTML = text;
                    }
                }

                var text = "";
                var firstLast = (parseInt(total[dates.length-1]) - parseInt(total[0]));

                if (firstLast > 0) {
                    text += "<p class='green-text'>+" + numeral(firstLast).format("0,0") + "<i class='material-icons'>arrow_upward</i></p>";
                } else if (firstLast < 0) {
                    text += "<p class='red-text'>" + numeral(firstLast).format("0,0") + "<i class='material-icons'>arrow_downward</i></p>";
                } else {
                    text += "<p class='blue-text'>" + numeral(firstLast).format("0,0") + "</p>";
                }

                document.getElementById("firstLast").innerHTML = text;
                document.getElementById("titolo").innerHTML = "Dati per '" + name + "' degli ultimi " + allDates.length + " giorni"
            }
        });
    });
</script>
{% endblock %}